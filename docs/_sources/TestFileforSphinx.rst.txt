.. comment:
    \begin{document}
    \title{Probabilistic Liquefaction Hazard Analysis: Code Development}
    \author{by Andrew Makdisi}
    \date{July 2019}
    \maketitle


.. _secGMdata:

Probabilistic Data for Peak Acceleration
=========================================

The ground motion hazard curve data used in ``PLHApy`` are obtained from
``nshmp-haz``, the Java-based platform created and maintained by the USGS
National Seismic Hazard Mapping Project (`<https://github.com/usgs/nshmp-haz>`_). The
``nshmp-haz`` platform is capable of running multi-site PSHA calculations to generate
hazard curves for spectral amplitude *IMs*, as well as perform deaggregation
calculations to characterize the distribution of magnitudes, source-site distances,
and epsilons that contribute to the  hazard at a particular rate of exceedance ([Baker2015]_). It includes the full catalog of seismic source models and ground motion model (GMM) logic trees used by USGS in the development of their National Seismic Hazard Maps, and is used as the source code for the deaggregation calculations that can be performed on the USGS seismic hazard website.

Generating Hazard Curves for :math:`a_{max}`
----------------------------------------------

The primary functionality of the ``nshmp-haz`` platform is its ``HazardCalc``
module, which performs PSHA calculations to produce hazard curves for a variety of
spectral amplitude-based intensity measures. A hazard curve is generated by calculating
the mean annual rate of exceedance of a discrete set of values of a given ground motion
*IM* using Equation (:ref:`eq_PSHA`). Generally, the set of values is
exponentially spaced, and selected to encompass the range of physically reasonable
values of the *IM* of interest. A typical ground motion hazard curve, showing the
variation in the annual rate of exceedance with respect to peak acceleration
:math:`a_{max}`, for a site in Seattle, Washington, is shown in 
:numref:`fig_SeaHazCurve`. In order to perform the PLHA calculation at regularly-spaced
intervals of :math:`a_{max}`, interpolation in :math:`a_{max}`-:math:`\log\lambda` space using cubic splines is required

.. _fig_SeaHazCurve:

.. figure:: Figures/SeattleHazCurve.png
    :align: center
    :alt: Seattle Hazard curve
    :width: 500px

    Hazard curve for peak acceleration :math:`a_{max}`, obtained using the 2014 National
    Seismic Hazard Map (NSHM14) for a site in Seattle, Washington (:math:`V_{s30}=215` m/s)}



Deaggregating :math:`a_{max}` Hazard by Magnitude
---------------------------------------------------

Since the cyclic stress-based PLHA framework for estimating :math:`FS_{L}` requires
probabilistic information about magnitude in addition to :math:`a_{max}`, the overall
hazard curve shown in :numref:`fig_SeaHazCurve` is insufficient for use in Equation
(:ref:`eq_PLHA`). Thus, for the range of :math:`a_{max}` values considered, the
conditional distribution of :math:`M_w` must be characterized through a process known
as *deaggregation*. Deaggregating the hazard at a particular period consists of determining, given
that a particular level of intensity measure has been exceeded, what the probability was that the
contributing earthquake featured a particular magnitude, distance, or combination of both (Baker,
2015). The ``DeaggCalc`` module in ``nshmp-haz`` calculates this probability for all combinations of magnitude and distance at a particular return period via:

.. _eq_DeagMR:
.. math::
	P\left[M_w=m_i,R=r_j|IM>im\right] = \frac{\lambda_{IM}(im|m_i,r_j)}{\lambda_{IM}(im)}


The resulting output can be plotted as a three-dimensional histogram as shown in 
:numref:`fig_SeaDeag`, where :math:`P\left[M_w=m_i,R=r_j|IM>im\right]`, often referred
to as the *percent contribution to overall hazard*, is plotted for each
combination of magnitude and distance. Given some additional knowledge about the
positions of major seismic sources relative to the site of interest, one can infer
which types of characteristic events are most likely to contribute to the ground
shaking intensity at this hazard level. The areas of highest percent contribution in
:numref:`fig_SeaDeag` are consistent with the three major sources of seismicity in greater Seattle
area: (1) Near-fault crustal events, in the magnitude 6.5-7.5 range, attributed primarily to the
Seattle Fault Zone (accounting for roughly 25\% of the overall hazard at this return period); (2)
Events that originate deep in the boundary between the Juan de Fuca and North American plates, known
as *intraslab* events (about 50\% contribution); and (3) Large magnitude-9 subduction earthquakes, originating offshore in the Cascadia Subduction Zone (about 25\% contribution). 

.. _fig_SeaDeag:
.. figure:: Figures/SeattleDeag.png
    :align: center
    :width: 600px

    Deaggregated hazard plot for a site in Seattle with :math:`V_{s30}=215` m/s, for the peak acceleration :math:`a_{max}` corresponding to a 1 in 2,475-year rate of exceedance.

For a particular :math:`a_{max}` value with a given total rate of exceedance, the
exceedance rates corresponding to specific magnitude bins can be obtained by multiplying
the overall :math:`\lambda_{a_{max}}` by the probability density of each magnitude bin,
which can be calculated by summing :math:`P\left[M_w=m_i,R=r_j|IM>im\right]` over all
values of :math:`R`:

.. _eq_DeagMw:
.. math::
	\mathrm{P}\left[M_w=m_i|IM>im\right] = \sum_{j=1}^{N_R}\mathrm{P}\left[M_w=m_i,R=r_j|IM>im\right]

The resulting marginal magnitude distribution for a particular return period is shown in
:numref:`fig_SeaMwDeag`. It is important to note, however, that the contributions of
different sources, magnitudes, and distances to ground shaking at a particular site will
vary with respect to the intensity of shaking. At the lower :math:`a_{max}` values
associated with shorter return periods, the hazard might see higher contributions from
more frequent events with relatively smaller magnitudes than those at longer return
periods. As a result, the marginal magnitude distribution given :math:`a_{max}` is not
constant with return period, and therefore requires multiple deaggregation calculations
to be performed over a broad range of shaking intensities. This is achieved by first
calling the ``DeaggCalc`` module multiple times for a predetermined range of return
periods, ranging from extremely short (roughly 5 years or so) to the maximum return
period possible in the ``DeaggCalc`` module, which is currently 20,000 years. The
resulting magnitude distribution for a given return period is then calculated via
Equation (:ref:`eq_DeagMw`). An annual rate of exceedance corresponding to a given
:math:`a_{max}`, for a particular magnitude bin, centered at :math:`M_w=m_i`, can be determined by multiplying the marginal magnitude probability by the overall rate of exceedance:

.. _eq_MwHazCurve:
.. math::
	\lambda_{a_i|M_w=m_i} = \lambda_{a_i}\mathrm{P}\left[M_w=m_i|a_{max}>a_i\right]

If this is performed for a series of return periods, a set
*magnitude-specific* :math:`a_{max}` *hazard curves* can be constructed. The
hazard curve values for several magnitudes are shown, along with the overall hazard
curve, in :numref:`fig_rawMwHaz`.

.. _fig_SeaMwDeag:
.. figure:: Figures/SeattleMagDist.png
    :align: center
    :alt: Seattle Mag district
    :width: 500px

    Deaggregated moment magnitude distribution for a site in Seattle, Washington with :math:`V_{s30}=215` m/s, for peak acceleration :math:`a_{max}` corresponding to a 2,475-year return period.


.. _fig_rawMwHaz:
.. figure:: Figures/SeattleMwCurves_Raw.png
    :align: center
    :alt: Seattle Hazard curve
    :width: 500px

    Overall hazard curve and selected magnitude-specific hazard curves, obtained from deaggregated hazard data at various return periods for a site in Seattle, Washington with with :math:`V_{s30}=215` m/s,}


Interpolation of Magnitude-Specific :math:`a_{max}` Hazard Curves
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

In order to perform the PLHA calculations at regularly-spaced intervals of
:math:`a_{max}`, the marginal magnitude distributions must be interpolated from the raw
deaggregation data. The most direct and robust way to do this is to interpolate the
:math:`M_w`-hazard curve values (:math:`\lambda_{a_{max}|M_w}`) calculated using
Equation (:ref:`eq_MwHazCurve`). This can be done using a similar cubic spline
interpolation in :math:`a_{max}`-:math:`\log\lambda` space as that employed to
interpolate the overall hazard curve shown in :numref:`fig_SeaHazCurve`. However, it
is important to recognize that the :math:`M_w`-specific hazard curves calculated here
are reconstructed from the product of the overall hazard curve and magnitude
distribution data as obtained from ``nshmp-haz``, rather than via a direct PSHA for
a given magnitude bin. The deaggregation output from ``DeaggCalc`` module truncates
all :math:`M_w` bin percentages below 0.01\% and presents them as zero-valued (as shown
for :math:`8.0<M_w<8.4` in :numref:`fig_SeaMwDeag`). In processing the data for a given deaggregation calculation, a correction scheme was adopted where the difference between the sum of all the magnitude percentages and 100\% was re-distributed evenly among all magnitude bins, thereby eliminating zero-valued magnitude probabilities. Because the differences in percent contribution were generally very small (less than about 0.3\%), the probabilities assigned to those magnitude intervals were very low, and the changes in marginal probabilities across all bins from the re-distributed difference were practically insignificant.

As a result, certain :math:`M_w` hazard curves do not exhibit the same smooth behavior
as the overall :math:`a_{max}` hazard curves usually do, often displaying sharp
irregularities that render basic spline fitting inapplicable. Referring back to 
:numref:`fig_rawMwHaz`, such irregular behavior can be seen in the :math:`M_w7.9` and
:math:`M_w8.1` curves, particularly at very low values of :math:`a_{max}` where the
percent contribution for that particular magnitude bin was exceedingly small. Based on a
review of raw deaggregated :math:`M_w` curves from 10 sites representing varying
seismo-tectonic environments distributed throughout the U.S.
(Table [#tab_TestSites]_),
a slightly modified interpolation scheme was developed to account
for such irregularities at low hazard levels and low percent-contribution portions of
the :math:`M_w` hazard curves. The scheme is based on identifying a "linear subset",
where potentially irregular behavior is accounted for by reverting to a simple linear
interpolation scheme in :math:`a_{max}`-:math:`\log\lambda` space, and splicing that
subset to the "spline subset", which consists of the smoothly varying datapoints that
can be interpolated accurately using a cubic spline. The scheme is implemented in the
following series of steps for given :math:`M_w`-specific hazard curve:

1. item Beginning with the lowest :math:`a_{max}` value and working upwards, track the number of consecutive :math:`\lambda_{a_i,M_w}` values for which the percent contribution of the :math:`M_w` bin is less than 2\% to the overall hazard. These value comprise the linear subset.

	a. However, if *any* value of :math:`a_{max}<0.02` g has a percent contribution less than 2\%, all data points less than 0.02 g are considered to be in the linear subset.


#. Once a value greater than 2\% contribution is reached, this value is also appended to the linear subset, in order to ensure that at least two points are used to linearly interpolate. 

#. The remaining data points comprise the spline subset, which shares a common endpoint with the linear subset.

#. If there are no points in the linear subset, the entire hazard curve is interpolated using a cubic spline.

#. If there are fewer than four points in the spline subset, the entire set is interpolated linearly in :math:`a_{max}`-:math:`\log\lambda` space.

#. Otherwise, the data from the two subsets are interpolated using their respective methods, and combined to form the full :math:`M_w`-specific interpolated hazard curve.


.. tabularcolumns:: |l|c|c|


Table [#tab_TestSites]_: Summary of test sites used in development and validation of PLHA code

=================== ============ ============= 
 Site                Latitude     Longitude    
=================== ============ ============= 
Charleston, SC      32.78        -79.93 
Eureka, CA          40.8         -124.16 
Los Angeles, CA     34.05        -118.24 
Memphis, TN         35.15        -90.05 
Minneapolis, MN     44.98        -93.27 
New York, NY        40.71        -74.01 
Salt Lake City, UT  40.76        -111.89 
San Francisco, CA   37.77        -122.42 
Seattle, WA         47.61        -122.33  
=================== ============ ============= 



Extrapolating Magnitude-Specific :math:`a_{max}` Hazard Curves Beyond 20,000-year Return Period
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

When any sort of analysis involving integration of fragility curves with *IM*
hazard data is undertaken, it is important to ensure that a sufficiently broad range of
intensity measure values is used, so that the resulting fragility curves reach stable
probabilities of exceedance of a particular *EDP*. In the case of PLHA, this
means that the :math:`M_w`-specific :math:`a_{max}` hazard curves must extend out to
large enough values of :math:`a_{max}` such that the non-exceedance term in Equation
(:ref:`eq_PLHA`) can reach a value of 1.0. However, as noted previously, the
``DeaggCalc`` module requires a target return period as input, rather than a
desired :math:`a_{max}` value, and is limited to performing deaggregation calculations
up to a return period of 20,000 years. Depending on the seismic environment and site
conditions, this return period may coincide with :math:`a_{max}` values that are lower
than those that would produce stable estimates of :math:`\Lambda_{FS_L}` from
fully-developed fragility curves. Thus, it is preferable to develop :math:`a_{max}`
hazard curves to a uniform maximum :math:`a_{max}` value, taken here to be 3.0 g. This
can necessitate extrapolation of some of the :math:`M_w` hazard curves, and an
assumption that the :math:`M_w` distribution at 20,000 years is constant for longer
return periods. Such an assumption is reasonable because at longer return periods
corresponding to high :math:`a_{max}` values, the source contribution is typically at or
very near the maximum magnitude (:math:`M_{max}`) and minimum distance (:math:`R_{min}`)
bins. Beyond that point, any increase hazard is largely controlled by an increase in
:math:`\varepsilon`, which is the number of standard deviations above the mean
:math:`a_{max}` for the :math:`M_{max}`-:math:`R_{min}` bin. The marginal magnitude
distributions shown in :numref:`fig_MwDists` for four of the sites from
Table [#tab_TestSites]_
generally confirm that the magnitude distributions stabilize at long return periods, and the use of the 20,000-year marginal magnitude distribution in extrapolating the magnitude hazard curves is reasonable. 

.. _fig_MwDists:
.. figure:: Figures/MultiSiteMwDist.png
    :align: center
    :width: 800px

    Marginal magnitude distributions for increasing :math:`a_{max}` return periods, for four geographic locations with :math:`V_{s30}=215` m/s

For return periods greater than 20,000 years, the cubic spline-interpolated values for
the overall hazard curve (obtained from the ``HazCalc``) are multiplied by the
percent contribution from the 20,000-year deaggregation (:numref:`fig_intExtMwHaz`).

.. _fig_intExtMwHaz:
.. figure:: Figures/SeattleMwCurves_IntExt.png
    :align: center
    :width: 500px

    Selected interpolated/extrapolated magnitude hazard curves for a site in Seattle, Washington}

To fully characterize the :math:`\lambda_{a_{max},M_w}` term in Equation
(:ref:`eq_PLHA`), the procedure for interpolating and extrapolating the raw deaggregation
data is repeated for all :math:`M_w` bins. The resulting full set of :math:`M_w` hazard
curves is shown for a site in Seattle in :numref:`fig_SeaAllCurves`. Note that the
specific :math:`M_w` values denote the *midpoints* of the magnitude bins, and are therefore influenced by the parameters of the deaggregation calculations, namely the minimum and maximum magnitudes, as well as the magnitude bin size.

.. _fig_SeaAllCurves:
.. figure:: Figures/SeattleMwCurves_ALL.png
    :align: center
    :width: 800px

    Full set of interpolated/extrapolated magnitude hazard curves for a site with :math:`V_{s30}=215` m/s in Seattle, Washington. Curves have been divided into four magnitude ranges for visual clarity.


*Maximum Acceleration for use in PLHA Calculations*
^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^

As stated previously, the :math:`M_w`-specific hazard curves are extrapolated in a
consistent manner out to :math:`a_{max}=3.0` g for all sites, in all seismo-tectonic
regions. The selection of 3.0 g is based on the maximum PGA used by USGS in their PSHA
framework to develop the national seismic hazard maps. Due to the fact that the USGS
hazard maps are developed for soft rock sites, an argument could be made that the
maximum :math:`a_{max}` considered in probabilistic liquefaction calculations, which
naturally occur at softer soil sites, should be lower due to non-linear considerations.
However, the general consensus in engineering seismology appears to be that there is
little justification in truncating ground motion distributions, either at a maximum
"physically possible" PGA or at some number of standard deviations above the median
predicted PGA ([Hanks2005]_, [Strasser2008]_). Furthermore, in terms of
calculating :math:`\Lambda_{FS_L}`, a scenario where the fragility curves are truncated
at an unreasonably low :math:`a_{max}` has the potential to result in lower exceedance
rates than what would be calculated from the full distribution, thus producing a
slightly unconservative estimate of the liquefaction hazard. The inclusion of the full
range of :math:`a_{max}` thus might produce, at worst, a slightly conservative representation of the liquefaction hazard, but currently there is no strong justification to do otherwise.  


.. rubric:: List of Tables

.. [#tab_TestSites] Summary of test sites used in development and validation of PLHA code


.. rubric:: References

.. [Baker2015]  Baker.
	Full reference to Baker,  (2015) ...
	
.. [Hanks2005] Hanks et al.,

.. [Strasser2008] Strasser et al.
